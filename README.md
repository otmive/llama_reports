# llama_reports
Using Llama to process radiology reports 

## Running Llama 3.1 to compare two reports

Install the required packages before running the script
```
pip install -r requirements.txt
```
Then access to llama needs to be granted. You can request access at https://huggingface.co/meta-llama/Llama-3.1-8B-Instruct
Once you have access the model, go to your profile, settings and then access tokens to generate a huggingface token. Then replace the value for `HF_TOKEN` in the top line of the script `get_score.py` with your access token just generated. 

After installing llama and the dependencies, you can run the `get_score.py` script on two reports as follows:

```
torchrun get_score.py "example_reports/example_pair/F_report.txt" "example_reports/example_pair/P_report.txt"
```
The example reports are generated by the LLM and are not of a real patient. 


## Running on mutiple report pairs
To run on a folder comparing report pairs eg. the folder `example_reports`, use the script `get_folder_score.py`:
```
torchrun get_folder_score.py "example_reports" "example_output.csv"
```
This script will create a csv file with rows of the name of the pair folder and the score for the two reports in that folder. 


## Changing weights for score calculation
The formula for the score has three weights: w_mismatch, w_missing and w_surplus with default values 1.75, 2 and 1 respectively. 
This is used to calculate the score with the formula $$ score = matches/(w_mismatch*mismatches + w_missing/missing + w_surplus*surplus) $$ where 'matches' and 'mismatches' etc. are the number of entities in these categories. 

You can compare reports with custom weights as follows:
```
torchrun get_score.py "example_reports/example_pair/F_report.txt" "example_reports/example_pair/P_report.txt" 2 2 0.5
```
This will set w_mismatch to 2, 2_missing to 2 and w_surplus to 0.5

## Get llama interpretation 
To get a comparison of the reports using only llama use `get_llama_score.py`.
```
torchrun  get_llama_score.py "example_reports/example_pair/F_report.txt" "example_reports/example_pair/P_report.txt"
```
You can also get the llama output for a folder of report pairs using `get_folder_score.py`
```
torchrun get_folder_score.py "example_reports" "example_llama_output.csv" --llama_score True
```

## Get cosine score of entities
To get a cosine score of the entities extracted from the two reports run `get_cosine_score.py`
```
python get_cosine_score.py "example_reports/example_pair/F_report.txt" "example_reports/example_pair/P_report.txt"
```